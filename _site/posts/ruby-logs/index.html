<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width; initial-scale=1.0, maximum-scale=1">
    <link href="http://gmpg.org/xfn/11" rel="profile">

    <title>
      Andrei Lisnic
    </title>

    <!-- CSS -->
    <link rel="stylesheet" href="/public/css/hyde.css">
    <link rel="stylesheet" href="/public/css/pygments.css">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600,700|Abril+Fatface">

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  </head>
  <body>

    <header class="masthead">
      <div class="masthead-inner">
        <h1><a href="/">Andrei Lisnic</a></h1>
        <ul>
          <li><a href="https://github.com/alisnic" >github</a></li>
          <li><a href="https://twitter.com/andrei_lisnic" >twitter</a></li>
          <li><a href="http://www.linkedin.com/in/alisnic" >linkedin</a></li>
          <li><a href="/atom.xml" >rss</a></li>
        </ul>
        <h3>Projects</h3>
        <ul>
          <li><a href="/nyny/">New York, New York</a></li>
        </ul>
      </div>
    </header>

    <div class="content container">
      <div class="post">
  <h1>Log filename, line and function name in ruby automatically</h1>
  <span class="post-date">11 May 2013</span>
  <p>Suppose you have a app with a logger:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">&#39;logger&#39;</span>

<span class="k">module</span> <span class="nn">MyApp</span>
  <span class="no">Log</span> <span class="o">=</span> <span class="no">Logger</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">STDOUT</span><span class="p">)</span>

  <span class="k">class</span> <span class="nc">Foo</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">hello</span>
      <span class="no">Log</span><span class="o">.</span><span class="n">info</span> <span class="s2">&quot;test message&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">MyApp</span><span class="o">::</span><span class="no">Foo</span><span class="o">.</span><span class="n">hello</span>
</code></pre></div>
<p>When you run it, everything is as usual:</p>
<div class="highlight"><pre><code class="console language-console" data-lang="console"><span class="go">I, [2013-05-11T21:26:40.701590 #4326]  INFO -- : test message</span>
</code></pre></div>
<p>Now imagine you have a ton of such messages flooding the output. Wouldn&#39;t be
nice if the logger would also include the filename, the line and the function
name where the Log output was issued? Well, you can do that in ruby:</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">&#39;logger&#39;</span>

<span class="k">module</span> <span class="nn">MyApp</span>
  <span class="no">Log</span> <span class="o">=</span> <span class="no">Logger</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">STDOUT</span><span class="p">)</span>
  <span class="no">Log</span><span class="o">.</span><span class="n">formatter</span> <span class="o">=</span> <span class="nb">proc</span> <span class="p">{</span> <span class="o">|</span><span class="n">severity</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">progname</span><span class="p">,</span> <span class="n">msg</span><span class="o">|</span>
    <span class="s2">&quot;</span><span class="si">#{</span><span class="n">severity</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="nb">caller</span><span class="o">[</span><span class="mi">4</span><span class="o">]</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">msg</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
  <span class="p">}</span>

  <span class="k">class</span> <span class="nc">Foo</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">hello</span>
      <span class="no">Log</span><span class="o">.</span><span class="n">info</span> <span class="s2">&quot;test message&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">MyApp</span><span class="o">::</span><span class="no">Foo</span><span class="o">.</span><span class="n">hello</span>
</code></pre></div>
<p>If we will run this, we&#39;ll see the following output:</p>
<div class="highlight"><pre><code class="console language-console" data-lang="console"><span class="go">INFO log_test.rb:14:in `hello&#39;: test message</span>
</code></pre></div>
<h1>How it is done</h1>

<p>Ruby has a magic array - <code>caller</code>. It contains the ordered list of the files, lines,
and functions being executed.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Foo</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">baz</span>
    <span class="n">hello</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">hello</span>
    <span class="nb">p</span> <span class="nb">caller</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Foo</span><span class="o">.</span><span class="n">baz</span> <span class="c1">#=&gt; [&quot;/home/andrei/Temp/log_test.rb:21:in `baz&#39;&quot;, &quot;/home/andrei/Temp/log_test.rb:29:in `&lt;main&gt;&#39;&quot;]</span>
</code></pre></div>
<p>We used that magic array for our logger formatter, and we used its 4th element
because the code which calls the logger is 4 levels above in call stack relative
to formatter proc.</p>

<p><strong>Note</strong>: If you use a different version of logger, you might need to use a
different number, not 4. In any case, inspect the caller array and see at which
position in that array your code info is located.</p>

</div>

<div>
  <h3>Related Posts</h3>
  <ul class="related-posts">
    
      <li>
        <h4>
          <a href="/posts/unity-fly">
            Unity performance tweaks
            <small>20 Mar 2013</small>
          </a>
        </h4>
      </li>
    
      <li>
        <h4>
          <a href="/posts/vim-run-hotkey">
            Vim hotkey to run current file depending on the filetype
            <small>11 Mar 2013</small>
          </a>
        </h4>
      </li>
    
      <li>
        <h4>
          <a href="/posts/rails-prototyping">
            Fast Rails app prototyping
            <small>23 Jan 2013</small>
          </a>
        </h4>
      </li>
    
  </ul>
</div>


<section class="meta">
  <div data-social-share-privacy='true'></div>
  <hr />
  <div id="disqus_thread"></div>

  <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'alisnic-github'; // required: replace example with your forum shortname

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
</section>


    </div>

    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-37064536-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
</html>
